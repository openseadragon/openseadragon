<!DOCTYPE html>
<html>
<head>
    <title>OpenSeadragon Cropping PolygonList Demo</title>
    <script type="text/javascript" src='../../build/openseadragon/openseadragon.js'></script>
    <script type="text/javascript" src='../lib/jquery-1.9.1.min.js'></script>
    <style type="text/css">

        .openseadragon1 {
            width: 800px;
            height: 600px;
            background: lightgreen;
        }

        textarea {
            width: 215px;
            height: 200px;
        }

        .box-with-title {
            padding-top: 1em;
            display: inline-block;
            text-align: center;
        }
        .buttons {
            width: 215px;
        }

        *:focus {
            outline: none;
        }

    </style>
</head>
<body>
    <h3>
        Simple demo page to show cropping with polygonList in a OpenSeadragon viewer.
    </h3>
    <div id="contentDiv" class="openseadragon1"></div>
    <span>Click on Viewer to save polygon points</span>
    <div>
        <button id='resetBtn'>Reset</button>
        <button id='exampleBtn'>Load Example</button>
        <button id="rotateLeft">Rotate - 10</button>
        <button id="rotateRight">Rotate + 10</button>
        <button id="rotateZero">Rotate to 0</button>
        <select id="selectedImage">
            <option>Index 0</option>
            <option>Index 1</option>
        </select>
    </div>
    <div class='box-with-title'>
        <div class="buttons">
            <button id="addPointBtn">Add Points as Polygon</button>
            <button onclick="emptyElement('polygonPointEl')">Clear</button>
        </div>
        <textarea id="polygonPointEl"></textarea>
    </div>
    <div class='box-with-title'>
        <div class="buttons">
            <button id="polygonCropBtn">Crop With Polygon</button>
            <button onclick="emptyElement('previewEl')">Clear</button>
        </div>
        <textarea id='previewEl'></textarea>
    </div>
    <div class='box-with-title'>
        <div class="buttons">
            <button id="pathCropBtn">Crop With Path</button>
            <button onclick="emptyElement('pathDEl')">Clear</button>
        </div>
        <textarea id='pathDEl'></textarea>
    </div>

    <!-- Setup Viewer -->
    <script type="text/javascript">
        var viewer = OpenSeadragon({
            // debugMode: true,
            // animationTime: 0,
            id: "contentDiv",
            prefixUrl: "../../build/openseadragon/images/",
            tileSources: "../data/testpattern.dzi",
            showNavigator: false,
            gestureSettingsMouse: {
                clickToZoom: false
            }
        });
        viewer.addTiledImage({
            tileSource: "../data/tall.dzi",
            x: 2,
            y: 0,
        });
    </script>

    <script>
        // Global Variables
        var previewEl = document.getElementById('previewEl');
        var polygonPointEl = document.getElementById('polygonPointEl');
        var pathDEl = document.getElementById('pathDEl');

        var examples =  [
            [{x: 480, y: 300},{x: 300, y: 420},{x: 600, y: 420}],                   // Triangle
            [{x: 500, y: 500},{x: 700, y: 500},{x: 700, y: 700},{x: 500, y: 700}]   // Rectangle
        ];
        var pathWithExclusion = [
            'M 500,500',  // Move to x: 500, y: 500
            'h 200',      // Draw a box of size 100
            'v 200',
            'h -200',
            'z',          // Close path
            'M 600,600',  // Move to x: 600, y:600
            'h 30',       // Draw a polygon as exclusion (evenodd rule)
            'l 30,40',
            'h -30',
            'z'           // Close Path
        ].join('');       // Join to make as a Path d string
        var heartShapePath = [
            'M 10,30',            // Move to x: 500, y: 500
            'A 20,20 0,0,1 50,30',  // Draw a heart shape
            'A 20,20 0,0,1 90,30',
            'Q 90,60 50,90',
            'Q 10,60 10,30',
            'z'                     // Close Path
        ].join('');                 // Join to make as a Path d string

        // Load default examples
        function loadExample(){
            previewEl.value = JSON.stringify(examples);
            pathDEl.value = JSON.stringify([pathWithExclusion, heartShapePath], null, 2);
        }
        loadExample();

        // Set a given element's value to empty string
        function emptyElement(elementId) {
            document.getElementById(elementId).value = '';
        }

        // JSON parse a given object, then insert object assuming parsed value is array.
        function insertObjectToElement(object, element) {
            var parsed = []; // Default to empty array
            try {
                parsed = JSON.parse(element.value);
            } catch(error) { }
            parsed.push(object);
            element.value = JSON.stringify(parsed)
        }

        // Add click handler to clicked point tracker
        viewer.addHandler('canvas-click', function(event) {
            var viewportPoint = viewer.viewport.pointFromPixel(event.position);
            var p = viewer.viewport.viewportToImageCoordinates(viewportPoint);
            p.x = Math.round((p.x + Number.EPSILON) * 100) / 100
            p.y = Math.round((p.y + Number.EPSILON) * 100) / 100
            insertObjectToElement({x:p.x, y:p.y}, polygonPointEl);
        });

        // Evaluate give element in JavaScript variable, default to empty array.
        function readElementValueDefaultToEmptyArray(elementId) {
            try {
                var val = document.getElementById(elementId).value;
                if (val === '') { return []; }
                return eval(val); // If using JSON.parse, user must put quotes [{"x": 123, "y":12}]
            } catch (e) {
                return [];
            }
        }

        // Insert value from given element into preview element
        function insertValueFromElementToPreviewElement(element) {
            try {
                if (element.value === '') { return; }
                var polygon = eval(element.value);
                var polygonList = readElementValueDefaultToEmptyArray('previewEl');
                polygonList.push(polygon);
                element.value = '';
                previewEl.value = JSON.stringify(polygonList);
            } catch(error) {
                console.log(error);
            }
        }

        function getSelectedTiledImage() {
            var index = document.getElementById('selectedImage').selectedIndex;
            return viewer.world.getItemAt(index);
        }

        // Add clicked points to polygon tracker variable as point objects
        document.getElementById('addPointBtn').onclick = function(){
            insertValueFromElementToPreviewElement(polygonPointEl);
        };

        // Crop image with value in the preview element
        document.getElementById('polygonCropBtn').onclick = function(){
            var polygonList = eval(previewEl.value);
            var tiledImage = getSelectedTiledImage();
            tiledImage.setCroppingPolygons(polygonList);
            viewer.forceRedraw();
            emptyElement('previewEl');
        };

        document.getElementById('resetBtn').onclick = function(){
            emptyElement('polygonPointEl');
            emptyElement('previewEl');
            emptyElement('pathDEl');
            var tiledImage = getSelectedTiledImage();
            tiledImage.resetCroppingPolygons();
            tiledImage.resetCroppingPaths();
            viewer.forceRedraw();
        };

        document.getElementById('exampleBtn').onclick = loadExample;

        document.getElementById('pathCropBtn').onclick = function() {
            var pathList = eval(pathDEl.value);
            var paths = pathList.map(function(path) {
                var svg = document.createElementNS("http://www.w3.org/2000/svg", "path");
                svg.setAttribute('d', path);
                return svg;
            });
            var tiledImage = getSelectedTiledImage();
            tiledImage.setCroppingPaths(paths);
            viewer.forceRedraw();
            emptyElement('pathDEl');
        }

        document.getElementById('rotateRight').onclick = function() {
            var degree = getSelectedTiledImage().getRotation();
            getSelectedTiledImage().setRotation(degree + 10);
        }
        document.getElementById('rotateLeft').onclick = function() {
            var degree = getSelectedTiledImage().getRotation();
            getSelectedTiledImage().setRotation(degree - 10);
        }
        document.getElementById('rotateZero').onclick = function() {
            getSelectedTiledImage().setRotation(0);
        }
    </script>

</body>
</html>
